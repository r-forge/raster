
if ( !isGeneric("correlation") ) {
	setGeneric("correlation", function(x, y, ...)
		standardGeneric("correlation"))
}


setMethod('correlation', signature(x='RasterLayer', y='RasterLayer'), 
	function(x, y, n=Inf, ...) {
		correlation(stack(x, y), n=n, ...)
	}
)


setMethod('correlation', signature(x='RasterStackBrick', y='missing'), 
	function(x, y, n=Inf, ...) {
		
		nl <- nlayers(x)
		if (nl < 2) return(1)
		
		if (n < ncell(x)) {
			x <- sampleRegular(x, size=n, asRaster=TRUE)
		}
		
		if (canProcessInMemory(x, nlayers(x)*4)) {
			s <- na.omit(getValues(x))
			s <- cor(s)
		} else {
			msk <- sum(x, na.rm=FALSE)
			x <- mask(x, msk)
			mx <- cellStats(x, mean)
			sx <- cellStats(x, sd)
			nc <- ncell(x)
			s <- matrix(NA, nrow=n, ncol=n)
			for (i in 1:(nl-1)) {
				for (j in (i+1):nl) {
					s[j,i] <- s[i,j] <- cellStats(((x[[i]] - mx[i]) * (x[[j]] - mx[j])) / (sx[i] * sx[j]), sum)/ (nc-1)
				}
			}
			diag(s) <- 1			
		}
		if (nrow(s) == 2) {
			s[2,1]
		} else {
			colnames(s) <- rownames(s) <- names(x)
			s		
		}
	}
)



